const path = require('path')
const { spawn } = require('child_process')

const defaultTimeout = 12 * 1000


const writeQuery = (c, query = 'Luke Skywalker') =>
  new Promise((resolve) => {
    c.stdin.write(`${query}\r`)

    c.stdout.on('data', (data) => {
      const s = data.toString()
      if (s[0] === '(') {
        resolve(s)
      }
    })

    c.stderr.on('data', (data) => {
      resolve(data.toString())
    })
  })

// const cli = () => {
//   c.on('error', (error) => {
//     console.log(`error: ${error.message}`)
//   })

//   c.on('close', (code) => {
//     console.log(`child process exited with code ${code}`)
//   })
// }

beforeEach(() => {
  const c = spawn('node', [path.resolve('./src/index.js')])
  c.stdin.setEncoding('utf-8')
})

afterEach(() => {
  c.kill('SIGINT')
})

test('Code should be 0', async () => {
  const QUERY = 'Luke Skywalker'

  writeQuery(QUERY).then((results) =>
    expect(results).toBe(
      'Luke Skywalker - A New Hope, The Empire Strikes Back, Return of the Jedi, Revenge of the Sith'
    )
  ),
    defaultTimeout
})
